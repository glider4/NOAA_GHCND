-- Ingest full data ".dly" files

-- Create staging table OBS

-- DROP TABLE OBS;
CREATE TABLE OBS (
	OBSNum INTEGER PRIMARY KEY NOT NULL,
	StationID CHAR(11) NOT NULL,
	Year INTEGER NOT NULL,
	Month INTEGER NOT NULL,
	Element CHAR(4) NOT NULL,
	V1 INTEGER,
	MF1 CHAR(1),
	QF1 CHAR(1),
	SF1 CHAR(3),
	V2 INTEGER,
	MF2 CHAR(1),
	QF2 CHAR(1),
	SF2 CHAR(3),
	V3 INTEGER,
	MF3 CHAR(1),
	QF3 CHAR(1),
	SF3 CHAR(3),
	V4 INTEGER,
	MF4 CHAR(1),
	QF4 CHAR(1),
	SF4 CHAR(3),
	V5 INTEGER,
	MF5 CHAR(1),
	QF5 CHAR(1),
	SF5 CHAR(3),
	V6 INTEGER,
	MF6 CHAR(1),
	QF6 CHAR(1),
	SF6 CHAR(3),
	V7 INTEGER,
	MF7 CHAR(1),
	QF7 CHAR(1),
	SF7 CHAR(3),
	V8 INTEGER,
	MF8 CHAR(1),
	QF8 CHAR(1),
	SF8 CHAR(3),
	V9 INTEGER,
	MF9 CHAR(1),
	QF9 CHAR(1),
	SF9 CHAR(3),
	V10 INTEGER,
	MF10 CHAR(1),
	QF10 CHAR(1),
	SF10 CHAR(3),
	V11 INTEGER,
	MF11 CHAR(1),
	QF11 CHAR(1),
	SF11 CHAR(3),
	V12 INTEGER,
	MF12 CHAR(1),
	QF12 CHAR(1),
	SF12 CHAR(3),
	V13 INTEGER,
	MF13 CHAR(1),
	QF13 CHAR(1),
	SF13 CHAR(3),
	V14 INTEGER,
	MF14 CHAR(1),
	QF14 CHAR(1),
	SF14 CHAR(3),
	V15 INTEGER,
	MF15 CHAR(1),
	QF15 CHAR(1),
	SF15 CHAR(3),
	V16 INTEGER,
	MF16 CHAR(1),
	QF16 CHAR(1),
	SF16 CHAR(3),
	V17 INTEGER,
	MF17 CHAR(1),
	QF17 CHAR(1),
	SF17 CHAR(3),
	V18 INTEGER,
	MF18 CHAR(1),
	QF18 CHAR(1),
	SF18 CHAR(3),
	V19 INTEGER,
	MF19 CHAR(1),
	QF19 CHAR(1),
	SF19 CHAR(3),
	V20 INTEGER,
	MF20 CHAR(1),
	QF20 CHAR(1),
	SF20 CHAR(3),
	V21 INTEGER,
	MF21 CHAR(1),
	QF21 CHAR(1),
	SF21 CHAR(3),
	V22 INTEGER,
	MF22 CHAR(1),
	QF22 CHAR(1),
	SF22 CHAR(3),
	V23 INTEGER,
	MF23 CHAR(1),
	QF23 CHAR(1),
	SF23 CHAR(3),
	V24 INTEGER,
	MF24 CHAR(1),
	QF24 CHAR(1),
	SF24 CHAR(3),
	V25 INTEGER,
	MF25 CHAR(1),
	QF25 CHAR(1),
	SF25 CHAR(3),
	V26 INTEGER,
	MF26 CHAR(1),
	QF26 CHAR(1),
	SF26 CHAR(3),
	V27 INTEGER,
	MF27 CHAR(1),
	QF27 CHAR(1),
	SF27 CHAR(3),
	V28 INTEGER,
	MF28 CHAR(1),
	QF28 CHAR(1),
	SF28 CHAR(3),
	V29 INTEGER,
	MF29 CHAR(1),
	QF29 CHAR(1),
	SF29 CHAR(3),
	V30 INTEGER,
	MF30 CHAR(1),
	QF30 CHAR(1),
	SF30 CHAR(3),
	V31 INTEGER,
	MF31 CHAR(1),
	QF31 CHAR(1),
	SF31 CHAR(3));

-- Ingest data from Python .csv conversion result
-- Used cygwin to remove "-9999" values that should be NULL
-- sed -i -e 's/-9999//g' "ghcnd-all-no9999.csv"
-- OR set null as -9999 in COPY line below
COPY OBS FROM 'D:/ghcnd-all-no9999.csv' (FORMAT CSV, DELIMITER(','));


-- Check import
SELECT * FROM OBS
WHERE SF2 = '-9999'
LIMIT 10;

-- Add Foreign Key to OBS if rest of dataset built
ALTER TABLE OBS
ADD CONSTRAINT obs_fkey1
FOREIGN KEY (StationID) REFERENCES STATIONS(StationID);


-- ONLY RUN BELOW UDPATES if sed command above was not run, and -9999 vals
-- still exist in data
-----------------------------------------------------------------------------


-- Update -9999 is NULL
UPDATE OBS
SET v1 = NULL
WHERE v1 = -9999;

UPDATE OBS
SET v2 = NULL
WHERE v2 = -9999;

UPDATE OBS
SET v3 = NULL
WHERE v3 = -9999;

UPDATE OBS
SET v4 = NULL
WHERE v4 = -9999;

UPDATE OBS
SET v5 = NULL
WHERE v5 = -9999;

UPDATE OBS
SET v6 = NULL
WHERE v6 = -9999;

UPDATE OBS
SET v7 = NULL
WHERE v7 = -9999;

UPDATE OBS
SET v8 = NULL
WHERE v8 = -9999;

UPDATE OBS
SET v9 = NULL
WHERE v9 = -9999;

UPDATE OBS
SET v10 = NULL
WHERE v10 = -9999;

UPDATE OBS
SET v11 = NULL
WHERE v11 = -9999;

UPDATE OBS
SET v12 = NULL
WHERE v12 = -9999;

UPDATE OBS
SET v13 = NULL
WHERE v13 = -9999;

UPDATE OBS
SET v14 = NULL
WHERE v14 = -9999;

UPDATE OBS
SET v15 = NULL
WHERE v15 = -9999;

UPDATE OBS
SET v16 = NULL
WHERE v16 = -9999;

UPDATE OBS
SET v17 = NULL
WHERE v17 = -9999;

UPDATE OBS
SET v18 = NULL
WHERE v18 = -9999;

UPDATE OBS
SET v19 = NULL
WHERE v19 = -9999;

UPDATE OBS
SET v20 = NULL
WHERE v20 = -9999;

UPDATE OBS
SET v21 = NULL
WHERE v21 = -9999;

UPDATE OBS
SET v22 = NULL
WHERE v22 = -9999;

UPDATE OBS
SET v23 = NULL
WHERE v23 = -9999;

UPDATE OBS
SET v24 = NULL
WHERE v24 = -9999;

UPDATE OBS
SET v25 = NULL
WHERE v25 = -9999;

UPDATE OBS
SET v26 = NULL
WHERE v26 = -9999;

UPDATE OBS
SET v27 = NULL
WHERE v27 = -9999;

UPDATE OBS
SET v28 = NULL
WHERE v28 = -9999;

UPDATE OBS
SET v29 = NULL
WHERE v29 = -9999;

UPDATE OBS
SET v30 = NULL
WHERE v30 = -9999;

UPDATE OBS
SET v31 = NULL
WHERE v31 = -9999;
